name: Build OpenWrt SplitDNS

on:
  workflow_dispatch:
#  push:
#    branches: [ "main" ]
#    paths:
#      - "build.sh"
#      - "scripts/**"
#      - "configs/**"
#      - ".github/workflows/**"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: free disk space (OpenWrt builds can be large)
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
            git gperf haveged help2man intltool libelf-dev libffi-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
            libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch \
            pkgconf python3 python3-distutils python3-pip python3-ply python3-setuptools \
            python3-venv qemu-utils rsync scons subversion swig texinfo unzip upx-ucl \
            vim wget zlib1g-dev file time
          df -h

      - name: Prepare ccache
        run: |
          echo "CCACHE_DIR=${{ github.workspace }}/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          mkdir -p "${{ github.workspace }}/.ccache"

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ github.ref_name }}-
            ${{ runner.os }}-ccache-

      - name: Cache dl directory
        uses: actions/cache@v4
        with:
          path: workdir/openwrt/dl
          key: ${{ runner.os }}-dl-${{ github.ref_name }}-${{ hashFiles('scripts/latest.sh','configs/**','build.sh') }}
          restore-keys: |
            ${{ runner.os }}-dl-${{ github.ref_name }}-
            ${{ runner.os }}-dl-

      - name: Build
        env:
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
        run: |
          set -euo pipefail
          chmod +x build.sh scripts/*.sh || true

          # Ensure ccache is used by OpenWrt
          export USE_CCACHE=1
          export CCACHE_DIR="${CCACHE_DIR}"
          ccache -z || true

          # IMPORTANT:
          # - Do NOT pipe to tee here.
          # - scripts/latest.sh already captures full logs, prints error summary on failure, and preserves exit code.
          ./build.sh

          ccache -s || true
          df -h
          echo "Build finished."

      - name: Collect artifacts
        if: always()
        env:
          # default OFF (set to "1" later if you want to ship ipk)
          UPLOAD_IPK: "0"
        run: |
          set -euo pipefail
          mkdir -p artifacts/firmware artifacts/logs artifacts/ipk

          # Logs from repo_root/logs (written by scripts/latest.sh)
          if [ -d logs ]; then
            cp -a logs/. artifacts/logs/ || true
          fi

          # Firmware (targets)
          if [ -d workdir/openwrt/bin/targets ]; then
            tar -C workdir/openwrt/bin -czf artifacts/firmware/targets.tar.gz targets || true

            find workdir/openwrt/bin/targets -type f \
              \( -name "*.img.gz" -o -name "*.vmdk" -o -name "*.vhdx" -o -name "*.qcow2" -o -name "*rootfs.tar.gz" -o -name "sha256sums" -o -name "*.manifest" \) \
              -print 2>/dev/null | \
              tar -czf artifacts/firmware/firmware_files.tar.gz -T - 2>/dev/null || true
          fi

          # Optional IPK packages (default OFF, and only create if *.ipk exists)
          if [ "${UPLOAD_IPK}" = "1" ] && [ -d workdir/openwrt/bin/packages ]; then
            if find workdir/openwrt/bin/packages -type f -name "*.ipk" -print -quit | grep -q .; then
              tar -C workdir/openwrt/bin -czf artifacts/ipk/packages.tar.gz packages || true
              echo "[ipk ] packages.tar.gz created"
            else
              echo "[ipk ] no *.ipk found, skip"
            fi
          else
            echo "[ipk ] disabled or packages dir missing, skip"
          fi

          echo "[debug] artifacts tree:"
          find artifacts -maxdepth 3 -type f -print || true

      - name: Upload firmware artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.ref_name }}-${{ github.run_number }}
          path: artifacts/firmware/
          retention-days: 14

      - name: Upload logs artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.ref_name }}-${{ github.run_number }}
          path: artifacts/logs/
          retention-days: 14

      - name: Upload ipk artifacts
        if: always() && hashFiles('artifacts/ipk/packages.tar.gz') != ''
        uses: actions/upload-artifact@v4
        with:
          name: ipk-${{ github.ref_name }}-${{ github.run_number }}
          path: artifacts/ipk/packages.tar.gz
          retention-days: 14
