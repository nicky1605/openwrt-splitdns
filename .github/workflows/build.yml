name: Build OpenWrt SplitDNS

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "build.sh"
      - "scripts/**"
      - "configs/**"
      - ".github/workflows/**"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: free disk space (OpenWrt builds can be large)
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler fastjar flex gawk gettext \
            git gperf haveged help2man intltool libelf-dev libffi-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
            libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch \
            pkgconf python3 python3-distutils python3-pip python3-ply python3-setuptools \
            python3-venv qemu-utils rsync scons subversion swig texinfo unzip upx-ucl \
            vim wget zlib1g-dev file time
          df -h

      - name: Prepare ccache
        run: |
          echo "CCACHE_DIR=${{ github.workspace }}/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV
          mkdir -p "${{ github.workspace }}/.ccache"

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-ccache-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ github.ref_name }}-
            ${{ runner.os }}-ccache-

      - name: Cache dl directory
        uses: actions/cache@v4
        with:
          path: workdir/openwrt/dl
          key: ${{ runner.os }}-dl-${{ github.ref_name }}-${{ hashFiles('scripts/latest.sh','configs/**','build.sh') }}
          restore-keys: |
            ${{ runner.os }}-dl-${{ github.ref_name }}-
            ${{ runner.os }}-dl-

      - name: Build
        env:
          # Make build deterministic and faster
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
        run: |
          set -euo pipefail
          chmod +x build.sh scripts/*.sh || true
          # Ensure ccache is used by OpenWrt
          export USE_CCACHE=1
          export CCACHE_DIR="${CCACHE_DIR}"
          ccache -z || true

          ./build.sh 2>&1 | tee build.log

          ccache -s || true
          df -h
          echo "Build finished."

      - name: Collect artifacts
        if: always()
        run: |
          set -euo pipefail
          mkdir -p artifacts

          # Build log
          cp -f build.log artifacts/ || true

          # Targets outputs (images, rootfs, manifests)
          if [ -d workdir/openwrt/bin/targets ]; then
            tar -C workdir/openwrt/bin -czf artifacts/targets.tar.gz targets
          fi

          # Also copy only common image types for convenience (best effort)
          find workdir/openwrt/bin/targets -type f \
            \( -name "*.img.gz" -o -name "*.vmdk" -o -name "*.vhdx" -o -name "*.qcow2" -o -name "*rootfs.tar.gz" -o -name "sha256sums" -o -name "*.manifest" \) \
            -print 2>/dev/null | \
            tar -czf artifacts/firmware_files.tar.gz -T - 2>/dev/null || true

          ls -lah artifacts || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-splitdns-${{ github.ref_name }}-${{ github.run_number }}
          path: artifacts/
          retention-days: 14
